<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Expense Tracker</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="hero">
    <div>
      <p class="eyebrow">Expense Tracker</p>
      <h1>hola mundo</h1>
      <p class="sub">Agrega, revisa y edita tus gastos sin instalar nada.</p>
      <div class="meta">
        <span class="pill">API /api/expenses</span>
        <span class="pill secondary">Autosave en JSON</span>
      </div>
    </div>
  </header>


  <main class="layout">
    <aside class="sidebar">
      <div class="sidebar-head">
        <p class="eyebrow">Modulos</p>
        <h3>Panel</h3>
      </div>
      <nav class="sidebar-nav">
        <a href="#mod-operaciones">Operaciones</a>
        <a href="#mod-reportes">Reportes</a>
        <a href="#mod-presupuesto">Presupuesto</a>
        <a href="#mod-conversor">Conversor</a>
        <a href="#mod-graficos">Graficos</a>
      </nav>
    </aside>

    <div class="content">
      <section id="mod-operaciones" class="module">
        <div class="module-head">
          <p class="eyebrow">Operaciones</p>
          <h2>Captura y consulta</h2>
        </div>
        <div class="module-grid">
          <section class="card">
            <div class="card-head">
              <h2>Nuevo gasto</h2>
              <p>Completa los campos y envia.</p>
            </div>
            <form id="form-gasto" class="form">
              <label>
                Descripcion
                <input type="text" id="descripcion" placeholder="Ej: Cena con amigos" required />
              </label>
              <label>
                Categoria
                <input type="text" id="categoria" placeholder="Comida, Transporte, etc." required />
              </label>
              <label>
                Monto
                <input type="number" step="0.01" id="monto" placeholder="0.00" required />
              </label>
              <label>
                Fecha
                <input type="date" id="fecha" />
              </label>
              <button type="submit">Agregar gasto</button>
              <p id="status" class="status" aria-live="polite"></p>
            </form>
          </section>

          <section class="card">
            <div class="card-head row">
              <div>
                <h2>Gastos</h2>
                <p>Lista actual desde la API.</p>
              </div>
              <button id="btn-recargar" class="ghost">Recargar</button>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Descripcion</th>
                    <th>Categoria</th>
                    <th>Monto</th>
                    <th>Fecha</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="tabla-gastos">
                  <tr><td colspan="6" class="muted">Sin datos aun</td></tr>
                </tbody>
              </table>
            </div>
          </section>

          <section class="card">
            <div class="card-head row">
              <div>
                <h2>Filtros y busqueda</h2>
                <p>Filtra por fecha, mes o categoria.</p>
              </div>
            </div>
            <div class="stack">
              <form id="form-fecha" class="row gap">
                <label class="inline">
                  Fecha
                  <input type="date" id="filtro-fecha" />
                </label>
                <button type="submit" class="ghost">Filtrar fecha</button>
                <span id="res-fecha" class="muted"></span>
              </form>
              <form id="form-mes" class="row gap">
                <label class="inline">
                  Mes
                  <input type="month" id="filtro-mes" />
                </label>
                <button type="submit" class="ghost">Filtrar mes</button>
                <span id="res-mes" class="muted"></span>
              </form>
              <form id="form-cat" class="row gap">
                <label class="inline">
                  Categoria
                  <input type="text" id="filtro-cat" placeholder="Ej: Comida" />
                </label>
                <button type="submit" class="ghost">Total por categoria</button>
                <span id="res-cat" class="muted"></span>
              </form>
            </div>
          </section>
        </div>
      </section>

      <section id="mod-reportes" class="module">
        <div class="module-head">
          <p class="eyebrow">Analitica</p>
          <h2>Reportes y estadisticas</h2>
        </div>
        <div class="module-grid">
          <section class="card">
            <div class="card-head">
              <h2>Reportes y estadisticas</h2>
              <p>Resumenes calculados con los datos actuales.</p>
            </div>
            <div class="metrics">
              <div class="stat"><p class="label">Total</p><p id="stat-total">-</p></div>
              <div class="stat"><p class="label">Minimo</p><p id="stat-min">-</p></div>
              <div class="stat"><p class="label">Maximo</p><p id="stat-max">-</p></div>
              <div class="stat"><p class="label">Promedio</p><p id="stat-avg">-</p></div>
              <div class="stat"><p class="label">Std Dev</p><p id="stat-std">-</p></div>
              <div class="stat"><p class="label">Prom. diario</p><p id="stat-daily">-</p></div>
              <div class="stat"><p class="label">Prom. mensual</p><p id="stat-monthly">-</p></div>
              <div class="stat"><p class="label">Top categoria</p><p id="stat-top">-</p></div>
              <div class="stat"><p class="label">Dias sin gasto</p><p id="stat-gaps">-</p></div>
            </div>
          </section>
        </div>
      </section>

      <section id="mod-presupuesto" class="module">
        <div class="module-head">
          <p class="eyebrow">Control</p>
          <h2>Presupuesto y alertas</h2>
        </div>
        <div class="module-grid">
          <section class="card">
            <div class="card-head row">
              <div>
                <h2>Presupuesto y alertas</h2>
                <p>Estado mensual y alertas de inactividad.</p>
              </div>
            </div>
            <div class="stack">
              <form id="form-presupuesto" class="row gap">
                <label class="inline">
                  Presupuesto mensual (COP)
                  <input type="number" step="0.01" min="0" id="presupuesto" />
                </label>
                <button type="submit" class="ghost">Guardar</button>
              </form>
              <p id="estado-presupuesto" class="status"></p>
              <p id="alerta-inactividad" class="status"></p>
            </div>
          </section>
        </div>
      </section>

      <section id="mod-conversor" class="module">
        <div class="module-head">
          <p class="eyebrow">Herramientas</p>
          <h2>Conversor</h2>
        </div>
        <div class="module-grid">
          <section class="card">
            <div class="card-head row">
              <div>
                <h2>Conversor</h2>
                <p>Convierte el total a otras monedas (tasas fijas del backend).</p>
              </div>
            </div>
            <div class="row gap">
              <select id="moneda">
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
                <option value="COP">COP</option>
              </select>
              <button id="btn-convertir" class="ghost">Convertir total</button>
              <span id="resultado-conversion" class="status"></span>
            </div>
          </section>
        </div>
      </section>

      <section id="mod-graficos" class="module">
        <div class="module-head">
          <p class="eyebrow">Visualizacion</p>
          <h2>Graficos (texto)</h2>
        </div>
        <div class="module-grid">
          <section class="card">
            <div class="card-head">
              <h2>Graficos (texto)</h2>
              <p>Barras por categoria y por mes.</p>
            </div>
            <div class="stack">
              <div>
                <p class="label">Por categoria</p>
                <pre id="chart-cat" class="chart"></pre>
              </div>
              <div>
                <p class="label">Por mes</p>
                <pre id="chart-mes" class="chart"></pre>
              </div>
            </div>
          </section>
        </div>
      </section>
    </div>
  </main>

  <script>
    const API_URL = "http://127.0.0.1:8000/api";

    const form = document.getElementById("form-gasto");
    const tabla = document.getElementById("tabla-gastos");
    const statusEl = document.getElementById("status");
    const btnRecargar = document.getElementById("btn-recargar");
    const formFecha = document.getElementById("form-fecha");
    const formMes = document.getElementById("form-mes");
    const formCat = document.getElementById("form-cat");
    const formPresupuesto = document.getElementById("form-presupuesto");
    const resultadoFecha = document.getElementById("res-fecha");
    const resultadoMes = document.getElementById("res-mes");
    const resultadoCat = document.getElementById("res-cat");
    const estadoPresupuesto = document.getElementById("estado-presupuesto");
    const alertaInactividad = document.getElementById("alerta-inactividad");
    const presupuestoInput = document.getElementById("presupuesto");
    const monedaSelect = document.getElementById("moneda");
    const btnConvertir = document.getElementById("btn-convertir");
    const resConversion = document.getElementById("resultado-conversion");
    const chartCat = document.getElementById("chart-cat");
    const chartMes = document.getElementById("chart-mes");
    let editingId = null;
    let cachedExpenses = [];
    const EXCHANGE_RATES = { COP: 1, USD: 0.00025, EUR: 0.00023 };
    const BUDGET_KEY = "budget_cop";

    function setStatus(message, isError = false) {
      statusEl.textContent = message;
      statusEl.classList.toggle("error", isError);
    }

    function today() {
      return new Date().toISOString().slice(0, 10);
    }
    document.getElementById("fecha").value = today();

    function formatMoney(value) {
      return Intl.NumberFormat("es-ES", { style: "currency", currency: "USD" }).format(value);
    }

    const statTotal = document.getElementById("stat-total");
    const statMin = document.getElementById("stat-min");
    const statMax = document.getElementById("stat-max");
    const statAvg = document.getElementById("stat-avg");
    const statStd = document.getElementById("stat-std");
    const statDaily = document.getElementById("stat-daily");
    const statMonthly = document.getElementById("stat-monthly");
    const statTop = document.getElementById("stat-top");
    const statGaps = document.getElementById("stat-gaps");

    function formatCOP(value) {
      return Intl.NumberFormat("es-ES", { style: "currency", currency: "COP" }).format(value);
    }

    async function cargarStats() {
      try {
        const res = await fetch(`${API_URL}/stats`);
        if (!res.ok) throw new Error("No se pudo obtener stats");
        const data = await res.json();
        const s = data.stats || {};
        statTotal.textContent = formatCOP(s.total || 0);
        statMin.textContent = formatCOP(s.min || 0);
        statMax.textContent = formatCOP(s.max || 0);
        statAvg.textContent = formatCOP(s.avg || 0);
        statStd.textContent = formatCOP(s.std_dev || 0);
        statDaily.textContent = formatCOP(s.daily_avg || 0);
        statMonthly.textContent = formatCOP(s.monthly_avg || 0);
        statTop.textContent = s.top_category ? `${s.top_category} (${formatCOP(s.top_category_amount || 0)})` : "-";
        statGaps.textContent = s.days_without_expense ?? "-";
      } catch (err) {
        console.error(err);
        [statTotal, statMin, statMax, statAvg, statStd, statDaily, statMonthly, statTop, statGaps].forEach(el => el.textContent = "-");
      }
    }

    async function actualizarPresupuesto() {
      try {
        const res = await fetch(`${API_URL}/budget/status`);
        if (!res.ok) return;
        const data = await res.json();
        if (data.budget) presupuestoInput.value = data.budget;
        if (data.status === "Superado") {
          estadoPresupuesto.textContent = `Presupuesto superado: ${formatCOP(data.spent)} / ${formatCOP(data.budget)}`;
          estadoPresupuesto.classList.add("error");
        } else if (data.status === "OK") {
          const restante = data.remaining ?? 0;
          estadoPresupuesto.textContent = `Presupuesto OK. Gastado ${formatCOP(data.spent || 0)}, disponible ${formatCOP(restante)}`;
          estadoPresupuesto.classList.remove("error");
        } else {
          estadoPresupuesto.textContent = "No hay presupuesto establecido.";
          estadoPresupuesto.classList.remove("error");
        }
      } catch (err) {
        console.error(err);
      }
    }

    async function actualizarAlertas() {
      try {
        const res = await fetch(`${API_URL}/alerts`);
        if (!res.ok) return;
        const data = await res.json();
        const alertText = (data.alerts || []).join(" | ");
        alertaInactividad.textContent = alertText || "";
        alertaInactividad.classList.toggle("error", alertText.toLowerCase().includes("superado"));
      } catch (err) {
        console.error(err);
      }
    }

    function renderChartsFromCache() {
      const totalsByCat = cachedExpenses.reduce((acc, e) => {
        acc[e.category] = (acc[e.category] || 0) + (Number(e.amount) || 0);
        return acc;
      }, {});
      const monthTotals = cachedExpenses.reduce((acc, e) => {
        const m = (e.date || "").slice(0, 7);
        acc[m] = (acc[m] || 0) + (Number(e.amount) || 0);
        return acc;
      }, {});
      const bar = (value, max, width = 24) => {
        if (max <= 0) return "";
        const len = Math.max(1, Math.round((value / max) * width));
        return "#".repeat(len);
      };
      const catEntries = Object.entries(totalsByCat || {});
      const maxCat = catEntries.length ? Math.max(...catEntries.map(([, v]) => v)) : 0;
      chartCat.textContent = catEntries.length
        ? catEntries.sort((a, b) => b[1] - a[1]).map(([k, v]) => `${k.padEnd(12, " ")} ${bar(v, maxCat)} ${formatCOP(v)}`).join("\n")
        : "Sin datos";
      const monthEntries = Object.entries(monthTotals || {});
      const maxMonth = monthEntries.length ? Math.max(...monthEntries.map(([, v]) => v)) : 0;
      chartMes.textContent = monthEntries.length
        ? monthEntries.sort((a, b) => a[0].localeCompare(b[0])).map(([k, v]) => `${k.padEnd(8, " ")} ${bar(v, maxMonth)} ${formatCOP(v)}`).join("\n")
        : "Sin datos";
    }
    async function cargarGastos() {
      setStatus("Cargando...");
      try {
        const res = await fetch(`${API_URL}/expenses`);
        if (!res.ok) throw new Error("Error al cargar gastos");
        const datos = await res.json();
        cachedExpenses = Array.isArray(datos) ? datos : [];
        if (!Array.isArray(datos) || datos.length === 0) {
          tabla.innerHTML = '<tr><td colspan="6" class="muted">Sin datos</td></tr>';
          setStatus("Sin datos aun");
          await cargarStats();
          await actualizarPresupuesto();
          await actualizarAlertas();
          renderChartsFromCache();
          return;
        }
        tabla.innerHTML = datos.map(g => `
          <tr data-id="${g.id}">
            <td>${g.id}</td>
            <td>${g.description}</td>
            <td>${g.category}</td>
            <td>${formatMoney(g.amount)}</td>
            <td>${g.date || "-"}</td>
            <td class="row-actions">
              <button class="ghost" data-action="edit" data-id="${g.id}">Editar</button>
              <button class="ghost danger" data-action="delete" data-id="${g.id}">Borrar</button>
            </td>
          </tr>
        `).join("");
        setStatus("Lista actualizada");
        await cargarStats();
        await actualizarPresupuesto();
        await actualizarAlertas();
        renderChartsFromCache();
      } catch (err) {
        console.error(err);
        tabla.innerHTML = '<tr><td colspan="6" class="muted">Error al cargar</td></tr>';
        setStatus("No se pudo cargar la lista", true);
      }
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const gasto = {
        description: document.getElementById("descripcion").value.trim(),
        category: document.getElementById("categoria").value.trim(),
        amount: parseFloat(document.getElementById("monto").value),
        date: document.getElementById("fecha").value || today(),
      };
      if (!gasto.description || !gasto.category || Number.isNaN(gasto.amount)) {
        setStatus("Completa los campos requeridos", true);
        return;
      }
      setStatus("Enviando...");
      try {
        const endpoint = editingId ? `${API_URL}/expenses/${editingId}` : `${API_URL}/expenses`;
        const method = editingId ? "PUT" : "POST";
        const res = await fetch(endpoint, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(gasto),
        });
        if (!res.ok) {
          const detail = await res.text();
          throw new Error(detail || "Error al guardar");
        }
        form.reset();
        editingId = null;
        form.querySelector("button[type='submit']").textContent = "Agregar gasto";
        setStatus(method === "POST" ? "Gasto agregado" : "Gasto actualizado");
        await cargarGastos();
      } catch (err) {
        console.error(err);
        setStatus("No se pudo guardar el gasto", true);
      }
    });

    tabla.addEventListener("click", async (e) => {
      const action = e.target.dataset.action;
      const id = e.target.dataset.id;
      if (!action || !id) return;

      if (action === "edit") {
        const targetExpense = cachedExpenses.find(x => String(x.id) === String(id));
        if (targetExpense) {
          document.getElementById("descripcion").value = targetExpense.description || "";
          document.getElementById("categoria").value = targetExpense.category || "";
          document.getElementById("monto").value = targetExpense.amount ?? "";
          document.getElementById("fecha").value = targetExpense.date || today();
        }
        editingId = id;
        form.querySelector("button[type='submit']").textContent = "Guardar cambios";
        setStatus(`Editando gasto #${id}`);
      }

      if (action === "delete") {
        const confirmed = confirm(`¿Eliminar gasto #${id}?`);
        if (!confirmed) return;
        setStatus("Eliminando...");
        try {
          const res = await fetch(`${API_URL}/expenses/${id}`, { method: "DELETE" });
          if (!res.ok) throw new Error("No se pudo eliminar");
          if (editingId === id) {
            editingId = null;
            form.reset();
            form.querySelector("button[type='submit']").textContent = "Agregar gasto";
          }
          setStatus("Gasto eliminado");
          await cargarGastos();
        } catch (err) {
          console.error(err);
          setStatus("Error al eliminar", true);
        }
      }
    });

    btnRecargar.addEventListener("click", cargarGastos);

    function formatCOP(value) {
      return Intl.NumberFormat("es-ES", { style: "currency", currency: "COP" }).format(value);
    }

    function actualizarReportes() {
      const amounts = cachedExpenses.map(e => Number(e.amount) || 0);
      const total = amounts.reduce((a, b) => a + b, 0);
      document.getElementById("stat-total").textContent = formatCOP(total);
      if (amounts.length === 0) {
        ["stat-min","stat-max","stat-avg","stat-std","stat-daily","stat-monthly","stat-top","stat-gaps"].forEach(id => {
          document.getElementById(id).textContent = "-";
        });
        renderCharts([], []);
        actualizarPresupuesto(total);
        actualizarAlertas();
        return;
      }
      document.getElementById("stat-min").textContent = formatCOP(Math.min(...amounts));
      document.getElementById("stat-max").textContent = formatCOP(Math.max(...amounts));
      const avg = amounts.reduce((a, b) => a + b, 0) / amounts.length;
      const std = Math.sqrt(amounts.reduce((sum, v) => sum + Math.pow(v - avg, 2), 0) / amounts.length);
      document.getElementById("stat-avg").textContent = formatCOP(avg.toFixed(2));
      document.getElementById("stat-std").textContent = formatCOP(std.toFixed(2));

      // Promedios diarios/mensuales
      const uniqueDates = [...new Set(cachedExpenses.map(e => e.date))].filter(Boolean);
      const uniqueMonths = [...new Set(cachedExpenses.map(e => (e.date || "").slice(0, 7)))].filter(Boolean);
      const sumAll = total;
      const dailyAvg = uniqueDates.length ? (sumAll / uniqueDates.length) : sumAll;
      const monthlyAvg = uniqueMonths.length ? (sumAll / uniqueMonths.length) : sumAll;
      document.getElementById("stat-daily").textContent = formatCOP(dailyAvg.toFixed(2));
      document.getElementById("stat-monthly").textContent = formatCOP(monthlyAvg.toFixed(2));

      // Top categoria
      const totalsByCat = cachedExpenses.reduce((acc, e) => {
        acc[e.category] = (acc[e.category] || 0) + (Number(e.amount) || 0);
        return acc;
      }, {});
      const topCat = Object.entries(totalsByCat).sort((a, b) => b[1] - a[1])[0];
      document.getElementById("stat-top").textContent = topCat ? `${topCat[0]} (${formatCOP(topCat[1])})` : "-";

      // Días sin gasto
      const datesParsed = uniqueDates.filter(Boolean).map(d => new Date(d));
      datesParsed.sort((a, b) => a - b);
      let gaps = 0;
      if (datesParsed.length >= 2) {
        for (let i = 1; i < datesParsed.length; i++) {
          const diff = (datesParsed[i] - datesParsed[i - 1]) / (1000 * 60 * 60 * 24);
          if (diff > 1) gaps += (diff - 1);
        }
      }
      document.getElementById("stat-gaps").textContent = gaps;

      renderCharts(totalsByCat, agruparPorMes(cachedExpenses));
      actualizarPresupuesto(total);
      actualizarAlertas();
    }

    function agruparPorMes(expenses) {
      return expenses.reduce((acc, e) => {
        const month = (e.date || "").slice(0, 7);
        acc[month] = (acc[month] || 0) + (Number(e.amount) || 0);
        return acc;
      }, {});
    }

    function renderCharts(catTotals, monthTotals) {
      const bar = (value, max, width = 24) => {
        if (max <= 0) return "";
        const len = Math.max(1, Math.round((value / max) * width));
        return "#".repeat(len);
      };
      const catEntries = Object.entries(catTotals || {});
      const maxCat = catEntries.length ? Math.max(...catEntries.map(([, v]) => v)) : 0;
      chartCat.textContent = catEntries.length
        ? catEntries.sort((a, b) => b[1] - a[1]).map(([k, v]) => `${k.padEnd(12, " ")} ${bar(v, maxCat)} ${formatCOP(v)}`).join("\n")
        : "Sin datos";
      const monthEntries = Object.entries(monthTotals || {});
      const maxMonth = monthEntries.length ? Math.max(...monthEntries.map(([, v]) => v)) : 0;
      chartMes.textContent = monthEntries.length
        ? monthEntries.sort((a, b) => a[0].localeCompare(b[0])).map(([k, v]) => `${k.padEnd(8, " ")} ${bar(v, maxMonth)} ${formatCOP(v)}`).join("\n")
        : "Sin datos";
    }

    function actualizarPresupuesto(total) {
      const stored = Number(localStorage.getItem(BUDGET_KEY) || 0);
      if (!Number.isNaN(stored) && stored > 0) {
        presupuestoInput.value = stored;
      }
      const month = new Date().toISOString().slice(0, 7);
      const gastadoMes = cachedExpenses
        .filter(e => (e.date || "").startsWith(month))
        .reduce((acc, e) => acc + (Number(e.amount) || 0), 0);
      if (!stored) {
        estadoPresupuesto.textContent = "No hay presupuesto establecido.";
        estadoPresupuesto.classList.remove("error");
        return;
      }
      if (gastadoMes > stored) {
        estadoPresupuesto.textContent = `Presupuesto superado: ${formatCOP(gastadoMes)} / ${formatCOP(stored)}`;
        estadoPresupuesto.classList.add("error");
      } else {
        const restante = stored - gastadoMes;
        estadoPresupuesto.textContent = `Presupuesto OK. Gastado ${formatCOP(gastadoMes)}, disponible ${formatCOP(restante)}`;
        estadoPresupuesto.classList.remove("error");
      }
    }

    function actualizarAlertas() {
      if (!cachedExpenses.length) {
        alertaInactividad.textContent = "No hay gastos registrados.";
        return;
      }
      const lastDateStr = cachedExpenses.map(e => e.date).filter(Boolean).sort().pop();
      if (!lastDateStr) {
        alertaInactividad.textContent = "Sin fecha en gastos.";
        return;
      }
      const last = new Date(lastDateStr);
      const diff = Math.floor((Date.now() - last.getTime()) / (1000 * 60 * 60 * 24));
      if (diff >= 3) {
        alertaInactividad.textContent = `No registras gastos hace ${diff} días.`;
        alertaInactividad.classList.add("error");
      } else {
        alertaInactividad.textContent = "Actividad reciente registrada.";
        alertaInactividad.classList.remove("error");
      }
    }

    formFecha.addEventListener("submit", (e) => {
      e.preventDefault();
      const d = document.getElementById("filtro-fecha").value;
      if (!d) {
        resultadoFecha.textContent = "Ingresa una fecha.";
        return;
      }
      const lista = cachedExpenses.filter(e => e.date === d);
      const total = lista.reduce((acc, e) => acc + (Number(e.amount) || 0), 0);
      resultadoFecha.textContent = `${lista.length} gasto(s), total ${formatCOP(total)}`;
    });

    formMes.addEventListener("submit", (e) => {
      e.preventDefault();
      const m = document.getElementById("filtro-mes").value;
      if (!m) {
        resultadoMes.textContent = "Ingresa un mes.";
        return;
      }
      const lista = cachedExpenses.filter(e => (e.date || "").startsWith(m));
      const total = lista.reduce((acc, e) => acc + (Number(e.amount) || 0), 0);
      resultadoMes.textContent = `${lista.length} gasto(s), total ${formatCOP(total)}`;
    });

    formCat.addEventListener("submit", (e) => {
      e.preventDefault();
      const c = document.getElementById("filtro-cat").value.trim().toLowerCase();
      if (!c) {
        resultadoCat.textContent = "Ingresa una categoria.";
        return;
      }
      const total = cachedExpenses
        .filter(e => (e.category || "").toLowerCase() === c)
        .reduce((acc, e) => acc + (Number(e.amount) || 0), 0);
      resultadoCat.textContent = `Total en ${c}: ${formatCOP(total)}`;
    });

    formPresupuesto.addEventListener("submit", (e) => {
      e.preventDefault();
      const val = Number(presupuestoInput.value);
      if (Number.isNaN(val) || val < 0) {
        estadoPresupuesto.textContent = "Valor inválido.";
        estadoPresupuesto.classList.add("error");
        return;
      }
      localStorage.setItem(BUDGET_KEY, val);
      estadoPresupuesto.textContent = "Presupuesto guardado.";
      estadoPresupuesto.classList.remove("error");
      actualizarPresupuesto();
    });

    btnConvertir.addEventListener("click", (e) => {
      e.preventDefault();
      const currency = monedaSelect.value;
      const total = cachedExpenses.reduce((acc, e) => acc + (Number(e.amount) || 0), 0);
      const rate = EXCHANGE_RATES[currency];
      if (!rate) {
        resConversion.textContent = "Moneda no soportada.";
        return;
      }
      const converted = Math.round(total * rate * 100) / 100;
      const formatter = currency === "COP" ? formatCOP : (v) => Intl.NumberFormat("es-ES", { style: "currency", currency }).format(v);
      resConversion.textContent = `${formatter(converted)} (desde ${formatCOP(total)})`;
    });

    cargarGastos();
  </script>
</body>
</html>
